(function(){var D=YAHOO.util.Dom,L=YAHOO.util.Event;var C=Alfresco.util.encodeHTML,H=Alfresco.util.userProfileLink;Alfresco.AuthorityFinder=function(O){Alfresco.AuthorityFinder.superclass.constructor.call(this,"Alfresco.AuthorityFinder",O,["button","container","datasource","datatable","json"]);this.itemSelectButtons={};this.searchTerm="";this.singleSelectedItem="";this.selectedItems={};this.notAllowed={};YAHOO.Bubbling.on("itemSelected",this.onItemSelected,this);YAHOO.Bubbling.on("itemDeselected",this.onItemDeselected,this);return this};YAHOO.lang.augmentObject(Alfresco.AuthorityFinder,{VIEW_MODE_DEFAULT:"",VIEW_MODE_COMPACT:"COMPACT",VIEW_MODE_FULLPAGE:"FULLPAGE"});YAHOO.lang.augmentObject(Alfresco.AuthorityFinder,{AUTHORITY_TYPE_ALL:"all",AUTHORITY_TYPE_USERS:"user",AUTHORITY_TYPE_GROUPS:"group"});YAHOO.lang.extend(Alfresco.AuthorityFinder,Alfresco.component.Base,{options:{siteId:"",viewMode:Alfresco.AuthorityFinder.VIEW_MODE_DEFAULT,authorityType:Alfresco.AuthorityFinder.AUTHORITY_TYPE_ALL,singleSelectMode:false,minSearchTermLength:0,maxSearchResults:100,wildcardPrefix:false,setFocus:false,addButtonSuffix:"",dataWebScript:Alfresco.constants.URL_SERVICECONTEXT+"components/people-finder/authority-query"},itemSelectButtons:null,searchTerm:null,singleSelectedItem:null,selectedItems:null,notAllowed:null,onReady:function G(){var P=this;if(this.options.viewMode==Alfresco.AuthorityFinder.VIEW_MODE_COMPACT){D.addClass(this.id+"-body","compact")}else{if(this.options.viewMode==Alfresco.AuthorityFinder.VIEW_MODE_FULLPAGE){D.setStyle(this.id+"-results","height","auto")}else{D.setStyle(this.id+"-results","height","300px")}}this.widgets.searchButton=Alfresco.util.createYUIButton(this,"authority-search-button",this.onSearchClick);var S=YAHOO.lang.substitute(this.options.dataWebScript,this.options);S+=(S.indexOf("?")<0)?"?":"&";S+="authorityType="+this.options.authorityType+"&";S+="maxResults="+this.options.maxSearchResults+"&";if(this.options.siteScope){S+="site="+this.options.siteScope+"&"}this.widgets.dataSource=new YAHOO.util.DataSource(S,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"authorities"}});this.widgets.dataSource.doBeforeParseData=function R(W,V){var U=V;if(V&&V.authorities){var T=V.authorities;if(T.length>P.options.maxSearchResults){T=T.slice(0,P.options.maxSearchResults-1)}P.notAllowed={};if(V.notAllowed){P.notAllowed=Alfresco.util.arrayToObject(V.notAllowed)}U={authorities:T}}return U};this._setupDataTable();D.get(this.id+"-title").innerHTML=this.msg("title."+this.options.authorityType);var Q=D.get(this.id+"-search-text");var O=new YAHOO.util.KeyListener(Q,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function(T,U,V){P.onSearchClick();L.stopEvent(U[1]);return false},scope:this,correctScope:true},YAHOO.env.ua.ie>0?YAHOO.util.KeyListener.KEYDOWN:"keypress");O.enable();if(this.options.setFocus){Q.focus()}},_setupDataTable:function B(){var Y=this;var W=function X(e,d,f,g){D.setStyle(e.parentNode,"width",f.width+"px");var b=d.getData("authorityType"),c=d.getData("metadata")||{},a=Alfresco.constants.URL_RESCONTEXT+"components/images/"+(b=="USER"?"no-user-photo-64.png":"group-64.png");if(c.avatar&&c.avatar.length!==0){a=Alfresco.constants.PROXY_URI+c.avatar+"?c=queue&ph=true"}d.setData("calc_iconUrl",a);e.innerHTML='<img class="avatar" src="'+a+'" alt="avatar" />'};var P=function T(h,j,d,b){var e=j.getData("authorityType"),f=j.getData("metadata"),c="";if(e=="USER"){var g=j.getData("shortName"),i=f.jobTitle||"",a=f.organization||"";c='<h3 class="itemname">'+H(g,j.getData("displayName"),'class="theme-color-1"')+' <span class="lighter">('+C(g)+")</span></h3>";if(i.length>0){c+='<div class="detail">'+C(i)+"</div>"}if(a.length>0){c+='<div class="detail">&nbsp;('+C(a)+")</div>"}}else{if(e=="GROUP"){c='<h3 class="itemname">'+C(j.getData("displayName"))+' <span class="lighter">('+C(j.getData("fullName"))+")</span></h3>"}}h.innerHTML=c};var O=function U(h,j,d,b){var e=j.getData("authorityType"),f=j.getData("metadata"),c="";if(e=="USER"){var g=j.getData("shortName"),i=f.jobTitle||"",a=f.organization||"";c='<h3 class="itemname">'+H(g,j.getData("displayName"),'class="theme-color-1"')+' <span class="lighter">('+C(g)+")</span></h3>";if(i.length>0){c+='<div class="detail"><span>'+Y.msg("label.title")+":</span> "+C(i)+"</div>"}if(a.length>0){c+='<div class="detail"><span>'+Y.msg("label.company")+":</span> "+C(a)+"</div>"}}else{if(e=="GROUP"){c='<h3 class="itemname">'+C(j.getData("displayName"))+"</h3>";c+='<div class="detail"><span>'+Y.msg("label.name")+":</span> "+C(j.getData("fullName"))+"</div>"}}h.innerHTML=c};var S=function R(d,b,f,h){D.setStyle(d.parentNode,"width",f.width+"px");D.setStyle(d.parentNode,"text-align","right");var e=Alfresco.util.generateDomId(),g='<span id="'+e+'"></span>',c=b.getData("fullName");d.innerHTML=g;if(Y.options.viewMode!==Alfresco.AuthorityFinder.VIEW_MODE_FULLPAGE){var a=new YAHOO.widget.Button({type:"button",label:Y.msg("button.add")+" "+Y.options.addButtonSuffix,name:e+"-name",container:e,disabled:c in Y.notAllowed,onclick:{fn:Y.onItemSelect,obj:b,scope:Y}});Y.itemSelectButtons[c]=a;if((c in Y.selectedItems)||(Y.options.singleSelectMode&&Y.singleSelectedItem!=="")){Y.itemSelectButtons[c].set("disabled",true)}}};var Q=this.options.viewMode==Alfresco.AuthorityFinder.VIEW_MODE_COMPACT,V=[{key:"authorityType",label:"Icon",sortable:false,formatter:W,width:(Q?36:70)},{key:"fullName",label:"Description",sortable:false,formatter:(Q?P:O)},{key:"actions",label:"Actions",sortable:false,formatter:S,width:80}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",V,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:this.msg("message.instructions")});this.widgets.dataTable.doBeforeLoadData=function Z(a,b,c){if(b.results){this.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}return true};this.widgets.dataTable.subscribe("rowMouseoverEvent",this.widgets.dataTable.onEventHighlightRow);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.widgets.dataTable.onEventUnhighlightRow)},clearResults:function N(){if(this.widgets.dataTable){var O=this.widgets.dataTable.getRecordSet().getLength();this.widgets.dataTable.deleteRows(0,O)}D.get(this.id+"-search-text").value="";this.singleSelectedItem="";this.selectedItems={}},onItemSelect:function A(O,P){YAHOO.Bubbling.fire("itemSelected",{itemName:P.getData("fullName"),shortName:P.getData("shortName"),displayName:P.getData("displayName"),iconUrl:P.getData("calc_iconUrl"),eventGroup:this})},onSearchClick:function K(P,Q){var O=D.get(this.id+"-search-text").value;if(O.length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});return}this.itemSelectButtons={};this._performSearch(O)},onItemSelected:function M(Q,O){var S=O[1];if(S&&(S.itemName!==null)){var R=S.itemName;this.selectedItems[R]=true;this.singleSelectedItem=R;if(this.options.singleSelectMode){for(var P in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(P)){this.itemSelectButtons[P].set("disabled",true)}}}else{this.itemSelectButtons[R].set("disabled",true)}}},onItemDeselected:function F(Q,O){var R=O[1];if(R&&(R.itemName!==null)){delete this.selectedItems[R.itemName];this.singleSelectedItem="";if(this.options.singleSelectMode){for(var P in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(P)){this.itemSelectButtons[P].set("disabled",false)}}}else{this.itemSelectButtons[R.itemName].set("disabled",false)}}},_setDefaultDataTableErrors:function I(O){var P=Alfresco.util.message;O.set("MSG_EMPTY",P("message.empty","Alfresco.AuthorityFinder"));O.set("MSG_ERROR",P("message.error","Alfresco.AuthorityFinder"))},_performSearch:function E(O){this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.set("MSG_EMPTY",this.msg("message.searching"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.widgets.dataTable.render();var Q=function P(T,U,V){this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,T,U,V)};var S=function R(U,V){if(V.status==401){window.location.reload()}else{try{var T=YAHOO.lang.JSON.parse(V.responseText);this.widgets.dataTable.set("MSG_ERROR",T.message);this.widgets.dataTable.showTableMessage(T.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(W){this._setDefaultDataTableErrors(this.widgets.dataTable)}}};this.searchTerm=O;this.widgets.dataSource.sendRequest(this._buildSearchParams(O),{success:Q,failure:S,scope:this})},_buildSearchParams:function J(O){return"filter="+(this.options.wildcardPrefix?"*":"")+encodeURIComponent(O)}})})();