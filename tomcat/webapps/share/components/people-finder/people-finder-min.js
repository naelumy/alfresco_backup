(function(){var B=YAHOO.util.Dom,U=YAHOO.util.Event;var N=Alfresco.util.encodeHTML,F=Alfresco.util.userProfileLink;Alfresco.PeopleFinder=function(V){Alfresco.PeopleFinder.superclass.constructor.call(this,"Alfresco.PeopleFinder",V,["button","container","datasource","datatable","json"]);this.userSelectButtons={};this.searchTerm="";this.singleSelectedUser="";this.selectedUsers={};this.notAllowed={};this.following={};YAHOO.Bubbling.on("personSelected",this.onPersonSelected,this);YAHOO.Bubbling.on("personDeselected",this.onPersonDeselected,this);return this};YAHOO.lang.augmentObject(Alfresco.PeopleFinder,{VIEW_MODE_DEFAULT:"",VIEW_MODE_COMPACT:"COMPACT",VIEW_MODE_FULLPAGE:"FULLPAGE"});YAHOO.lang.extend(Alfresco.PeopleFinder,Alfresco.component.Base,{options:{siteId:"",viewMode:Alfresco.PeopleFinder.VIEW_MODE_DEFAULT,singleSelectMode:false,showSelf:true,minSearchTermLength:0,maxSearchResults:100,setFocus:false,addButtonLabel:null,addButtonSuffix:"",dataWebScript:"",userId:""},userSelectButtons:null,searchTerm:null,singleSelectedUser:null,selectedUsers:null,notAllowed:null,isSearching:false,followingAllowed:false,following:null,onReady:function S(){var W=this;if(this.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_COMPACT){B.addClass(this.id+"-body","compact");B.removeClass(this.id+"-results","hidden")}else{if(this.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_FULLPAGE){B.setStyle(this.id+"-results","height","auto");B.removeClass(this.id+"-help","hidden");Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"api/subscriptions/"+encodeURIComponent(this.options.userId)+"/following",successCallback:{fn:function(a){if(a.json.people){var d={};var c=a.json.people;for(var b=0;b<c.length;b++){d[c[b].userName]=true}W.following=d}W.followingAllowed=true},scope:this}})}else{B.setStyle(this.id+"-results","height","300px");B.removeClass(this.id+"-results","hidden")}}this.widgets.searchButton=Alfresco.util.createYUIButton(this,"search-button",this.onSearchClick);var Z=Alfresco.constants.PROXY_URI+YAHOO.lang.substitute(this.options.dataWebScript,this.options);Z+=(Z.indexOf("?")<0)?"?":"&";this.widgets.dataSource=new YAHOO.util.DataSource(Z,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"people"}});this.widgets.dataSource.doBeforeParseData=function Y(f,c){var b=c;if(c){var a=c.people,d,e;if(a.length>W.options.maxSearchResults){a=a.slice(0,W.options.maxSearchResults-1)}if(!W.options.showSelf){for(d=0,e=a.length;d<e;d++){if(a[d].userName==Alfresco.constants.USERNAME){a.splice(d,1);break}}}W.notAllowed={};if(c.notAllowed){W.notAllowed=Alfresco.util.arrayToObject(c.notAllowed)}b={people:a}}return b};this._setupDataTable();var X=B.get(this.id+"-search-text");var V=new YAHOO.util.KeyListener(X,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function(a,b,c){W.onSearchClick();U.stopEvent(b[1]);return false},scope:this,correctScope:true},YAHOO.env.ua.ie>0?YAHOO.util.KeyListener.KEYDOWN:"keypress");V.enable();if(this.options.setFocus){X.focus()}},fnRenderCellAvatar:function A(){var W=this;return function V(Z,Y,a,b){B.setStyle(Z.parentNode,"width",a.width+"px");var X=Alfresco.constants.URL_RESCONTEXT+"components/images/no-user-photo-64.png";if(Y.getData("avatar")!==undefined){X=Alfresco.constants.PROXY_URI+Y.getData("avatar")+"?c=queue&ph=true"}Z.innerHTML='<img class="avatar" src="'+X+'" alt="avatar" />'}},fnRenderCellDescription:function C(){var W=this;return function V(g,j,d,a){var f=j.getData("userName"),Z=f,h=j.getData("firstName"),i=j.getData("lastName"),X=j.getData("userStatus"),b=j.getData("userStatusTime");if((h!==undefined)||(i!==undefined)){Z=h?h+" ":"";Z+=i?i:""}var e=j.getData("jobtitle")||"",Y=j.getData("organization")||"";var c='<h3 class="itemname">'+F(f,Z,'class="theme-color-1" tabindex="0"')+' <span class="lighter">('+N(f)+")</span></h3>";if(e.length!==0){if(W.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_COMPACT){c+='<div class="detail">'+N(e)+"</div>"}else{c+='<div class="detail"><span>'+W.msg("label.title")+":</span> "+N(e)+"</div>"}}if(Y.length!==0){if(W.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_COMPACT){c+='<div class="detail">&nbsp;('+N(Y)+")</div>"}else{c+='<div class="detail"><span>'+W.msg("label.company")+":</span> "+N(Y)+"</div>"}}if(X!==null&&W.options.viewMode!==Alfresco.PeopleFinder.VIEW_MODE_COMPACT){c+='<div class="user-status">'+N(X)+" <span>("+Alfresco.util.relativeTime(Alfresco.util.fromISO8601(b.iso8601))+")</span></div>"}g.innerHTML=c}},fnRenderCellActions:function P(){var V=this;return function W(b,Z,c,e){B.setStyle(b.parentNode,"width",c.width+"px");B.setStyle(b.parentNode,"text-align","right");var a=Z.getData("userName"),d='<span id="'+V.id+"-action-"+a+'"></span>';b.innerHTML=d;if(V.options.viewMode!==Alfresco.PeopleFinder.VIEW_MODE_FULLPAGE){var X=new YAHOO.widget.Button({type:"button",label:(V.options.addButtonLabel?V.options.addButtonLabel:V.msg("button.add"))+" "+V.options.addButtonSuffix,name:V.id+"-selectbutton-"+a,container:V.id+"-action-"+a,tabindex:0,disabled:a in V.notAllowed,onclick:{fn:V.onPersonSelect,obj:Z,scope:V}});V.userSelectButtons[a]=X;if((a in V.selectedUsers)||(V.options.singleSelectMode&&V.singleSelectedUser!=="")){V.userSelectButtons[a].set("disabled",true)}}if(V._renderFollowingActions(Z)){var Y=V.following[a];var X=new YAHOO.widget.Button({type:"button",label:Y?V.msg("button.unfollow"):V.msg("button.follow"),name:V.id+"-followbutton-"+a,container:V.id+"-action-"+a,tabindex:0});X.set("onclick",{fn:Y?V.onPersonUnfollow:V.onPersonFollow,obj:{record:Z,button:X},scope:V})}}},_renderFollowingActions:function T(V){return(this.followingAllowed&&this.options.viewMode===Alfresco.PeopleFinder.VIEW_MODE_FULLPAGE&&this.options.userId!==V.getData("userName"))},_setupDataTable:function I(){var W=[{key:"avatar",label:"Avatar",sortable:false,formatter:this.fnRenderCellAvatar(),width:this.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_COMPACT?36:70},{key:"person",label:"Description",sortable:false,formatter:this.fnRenderCellDescription()},{key:"actions",label:"Actions",sortable:false,formatter:this.fnRenderCellActions(),width:80}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",W,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,MSG_EMPTY:this.msg("message.instructions")});this.widgets.dataTable.doBeforeLoadData=function V(X,Y,Z){if(Y.results){this.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}return true};this.widgets.dataTable.subscribe("rowMouseoverEvent",this.widgets.dataTable.onEventHighlightRow);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.widgets.dataTable.onEventUnhighlightRow)},clearResults:function E(){if(this.widgets.dataTable){var V=this.widgets.dataTable.getRecordSet().getLength();this.widgets.dataTable.deleteRows(0,V)}B.get(this.id+"-search-text").value="";this.singleSelectedUser="";this.selectedUsers={}},onPersonSelect:function D(V,X){var W=X.getData("userName");YAHOO.Bubbling.fire("personSelected",{eventGroup:this,userName:W,firstName:X.getData("firstName"),lastName:X.getData("lastName"),email:X.getData("email")})},onPersonFollow:function L(W,Y){var X=Y.record.getData("userName");Y.button.set("disabled",true);var V=this;Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/subscriptions/"+encodeURIComponent(this.options.userId)+"/follow",method:Alfresco.util.Ajax.POST,dataObj:[X],requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(Z){Y.button.set("label",V.msg("button.unfollow"));Y.button.set("onclick",{fn:V.onPersonUnfollow,obj:{record:Y.record,button:Y.button},scope:V});V.following[X]=true;Y.button.set("disabled",false)},scope:this},failureCallback:{fn:function(a){var Z=Alfresco.util.parseJSON(a.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:this._msg("message.failure"),text:Z.message});Y.button.set("disabled",false)},scope:this}})},onPersonUnfollow:function M(W,Y){var X=Y.record.getData("userName");Y.button.set("disabled",true);var V=this;Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/subscriptions/"+encodeURIComponent(this.options.userId)+"/unfollow",method:Alfresco.util.Ajax.POST,dataObj:[X],requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(Z){Y.button.set("label",V.msg("button.follow"));Y.button.set("onclick",{fn:V.onPersonFollow,obj:{record:Y.record,button:Y.button},scope:V});V.following[X]=false;Y.button.set("disabled",false)},scope:this},failureCallback:{fn:function(a){var Z=Alfresco.util.parseJSON(a.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:this._msg("message.failure"),text:Z.message});Y.button.set("disabled",false)},scope:this}})},onSearchClick:function Q(W,X){var V=B.get(this.id+"-search-text").value;if(V.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});return}this.userSelectButtons={};this._performSearch(V)},onPersonSelected:function G(X,V){var Z=V[1];if(Z&&(Z.userName!==undefined)){var Y=Z.userName;this.selectedUsers[Y]=true;this.singleSelectedUser=Y;if(this.options.singleSelectMode){for(var W in this.userSelectButtons){if(this.userSelectButtons.hasOwnProperty(W)){this.userSelectButtons[W].set("disabled",true)}}}else{if(this.userSelectButtons[Y]){this.userSelectButtons[Y].set("disabled",true)}}}},onPersonDeselected:function O(X,V){var Y=V[1];if(Y&&(Y.userName!==undefined)){delete this.selectedUsers[Y.userName];this.singleSelectedUser="";if(this.options.singleSelectMode){for(var W in this.userSelectButtons){if(this.userSelectButtons.hasOwnProperty(W)){this.userSelectButtons[W].set("disabled",false)}}}else{if(this.userSelectButtons[Y.userName]){this.userSelectButtons[Y.userName].set("disabled",false)}}}},_setDefaultDataTableErrors:function H(V){var W=Alfresco.util.message;V.set("MSG_EMPTY",W("message.empty","Alfresco.PeopleFinder"));V.set("MSG_ERROR",W("message.error","Alfresco.PeopleFinder"))},_performSearch:function R(V){if(!this.isSearching){this.isSearching=true;this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.set("MSG_EMPTY",this.msg("message.searching"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());var W=function Y(a,b,c){if(this.options.viewMode!=Alfresco.PeopleFinder.VIEW_MODE_COMPACT){if(B.hasClass(this.id+"-results","hidden")){B.removeClass(this.id+"-results","hidden");B.addClass(this.id+"-help","hidden")}}this._enableSearchUI();this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,a,b,c)};var X=function Z(b,c){this._enableSearchUI();if(c.status==401){window.location.reload()}else{try{var a=YAHOO.lang.JSON.parse(c.responseText);this.widgets.dataTable.set("MSG_ERROR",a.message);this.widgets.dataTable.showTableMessage(a.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(d){this._setDefaultDataTableErrors(this.widgets.dataTable)}}};this.searchTerm=V;this.widgets.dataSource.sendRequest(this._buildSearchParams(V),{success:W,failure:X,scope:this});this.widgets.searchButton.set("disabled",true);YAHOO.lang.later(2000,this,function(){if(this.isSearching){if(!this.widgets.feedbackMessage){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.searching",this.name),spanClass:"wait",displayTime:0})}else{if(!this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.show()}}}},[])}},_enableSearchUI:function J(){if(this.widgets.feedbackMessage&&this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.hide()}this.widgets.searchButton.set("disabled",false);this.isSearching=false},_buildSearchParams:function K(V){return"filter="+encodeURIComponent(V)+"&maxResults="+this.options.maxSearchResults}})})();