(function(){var G=YAHOO.util.Dom,N=YAHOO.util.Event;var D=Alfresco.util.encodeHTML;Alfresco.GroupFinder=function(P){Alfresco.GroupFinder.superclass.constructor.call(this,"Alfresco.GroupFinder",P,["button","container","datasource","datatable","json"]);this.itemSelectButtons={};this.searchTerm="";this.singleSelectedItem="";this.selectedItems={};this.notAllowed={};this.eventGroup=P;YAHOO.Bubbling.on("itemSelected",this.onItemSelected,this);YAHOO.Bubbling.on("itemDeselected",this.onItemDeselected,this);YAHOO.Bubbling.on("allItemsDeselected",this.onAllItemsDeselected,this);return this};YAHOO.lang.augmentObject(Alfresco.GroupFinder,{VIEW_MODE_DEFAULT:"",VIEW_MODE_COMPACT:"COMPACT",VIEW_MODE_FULLPAGE:"FULLPAGE"});YAHOO.lang.extend(Alfresco.GroupFinder,Alfresco.component.Base,{options:{siteId:"",viewMode:Alfresco.GroupFinder.VIEW_MODE_DEFAULT,singleSelectMode:false,minSearchTermLength:0,maxSearchResults:100,wildcardPrefix:false,setFocus:false,addButtonSuffix:"",dataWebScript:""},itemSelectButtons:null,searchTerm:null,singleSelectedItem:null,selectedItems:null,notAllowed:null,isSearching:false,onReady:function H(){var R=this;if(this.options.viewMode==Alfresco.GroupFinder.VIEW_MODE_COMPACT){G.addClass(this.id+"-body","compact")}else{if(this.options.viewMode==Alfresco.GroupFinder.VIEW_MODE_FULLPAGE){G.setStyle(this.id+"-results","height","auto")}else{G.setStyle(this.id+"-results","height","300px")}}this.widgets.searchButton=Alfresco.util.createYUIButton(this,"group-search-button",this.onSearchClick);var Q=Alfresco.constants.PROXY_URI+YAHOO.lang.substitute(this.options.dataWebScript,this.options);Q+=(Q.indexOf("?")<0)?"?":"&";Q+="zone=APP.DEFAULT&";this.widgets.dataSource=new YAHOO.util.DataSource(Q,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"data"}});this.widgets.dataSource.doBeforeParseData=function T(X,W){var V=W;if(W&&W.data){var U=W.data;if(U.length>R.options.maxSearchResults){U=U.slice(0,R.options.maxSearchResults-1)}R.notAllowed={};if(W.notAllowed){R.notAllowed=Alfresco.util.arrayToObject(W.notAllowed)}V={data:U}}return V};this._setupDataTable();var S=G.get(this.id+"-search-text");var P=new YAHOO.util.KeyListener(S,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function(U,V,W){R.onSearchClick();N.stopEvent(V[1]);return false},scope:this,correctScope:true},YAHOO.env.ua.ie>0?YAHOO.util.KeyListener.KEYDOWN:"keypress");P.enable();if(this.options.setFocus){S.focus()}},_setupDataTable:function E(){var W=this;var U=function Q(Z,Y,a,b){G.setStyle(Z.parentNode,"width",a.width+"px");Z.innerHTML='<img class="avatar" src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/group-64.png" alt="avatar" />'};var P=function R(Z,Y,a,c){var b='<h3 class="itemname">'+D(Y.getData("displayName"))+"</h3>";if(W.options.viewMode!==Alfresco.GroupFinder.VIEW_MODE_COMPACT){b+='<div class="detail"><span>'+W.msg("label.name")+":</span> "+D(Y.getData("fullName"))+"</div>"}Z.innerHTML=b};var T=function X(b,Z,d,f){G.setStyle(b.parentNode,"width",d.width+"px");G.setStyle(b.parentNode,"text-align","right");var c=Alfresco.util.generateDomId(),e='<span id="'+c+'"></span>',a=Z.getData("fullName");b.innerHTML=e;if(W.options.viewMode!==Alfresco.GroupFinder.VIEW_MODE_FULLPAGE){var Y=new YAHOO.widget.Button({type:"button",label:W.msg("button.add")+" "+W.options.addButtonSuffix,name:c+"-name",container:c,disabled:a in W.notAllowed,onclick:{fn:W.onItemSelect,obj:Z,scope:W}});W.itemSelectButtons[a]=Y;if((a in W.selectedItems)||(W.options.singleSelectMode&&W.singleSelectedItem!=="")){W.itemSelectButtons[a].set("disabled",true)}}};var V=[{key:"icon",label:"Icon",sortable:false,formatter:U,width:this.options.viewMode==Alfresco.GroupFinder.VIEW_MODE_COMPACT?36:70},{key:"description",label:"Description",sortable:false,formatter:P},{key:"actions",label:"Actions",sortable:false,formatter:T,width:80}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",V,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:this.msg("message.instructions")});this.widgets.dataTable.doBeforeLoadData=function S(Y,Z,a){if(Z.results){this.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}return true};this.widgets.dataTable.subscribe("rowMouseoverEvent",this.widgets.dataTable.onEventHighlightRow);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.widgets.dataTable.onEventUnhighlightRow)},clearResults:function A(){if(this.widgets.dataTable){var P=this.widgets.dataTable.getRecordSet().getLength();this.widgets.dataTable.deleteRows(0,P)}G.get(this.id+"-search-text").value="";this.singleSelectedItem="";this.selectedItems={}},onItemSelect:function C(P,Q){YAHOO.Bubbling.fire("itemSelected",{eventGroup:this,itemName:Q.getData("fullName"),displayName:Q.getData("displayName")})},onSearchClick:function J(Q,R){var P=YAHOO.lang.trim(G.get(this.id+"-search-text").value);if(P.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});return}this.itemSelectButtons={};this._performSearch(P)},onItemSelected:function I(R,P){var T=P[1];if(T&&(T.itemName!==null)&&(!T.eventGroup||(T.eventGroup&&Alfresco.util.hasEventInterest(this,P)))){var S=T.itemName;this.selectedItems[S]=true;this.singleSelectedItem=S;if(this.options.singleSelectMode){for(var Q in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(Q)){this.itemSelectButtons[Q].set("disabled",true)}}}else{if(this.itemSelectButtons[S]){this.itemSelectButtons[S].set("disabled",true)}}}},onItemDeselected:function O(R,P){var S=P[1];if(S&&(S.itemName!==null)&&(!S.eventGroup||(S.eventGroup&&Alfresco.util.hasEventInterest(this,P)))){delete this.selectedItems[S.itemName];this.singleSelectedItem="";if(this.options.singleSelectMode){for(var Q in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(Q)){this.itemSelectButtons[Q].set("disabled",false)}}}else{if(this.itemSelectButtons[S.itemName]){this.itemSelectButtons[S.itemName].set("disabled",false)}}}},onAllItemsDeselected:function L(R,P){var S=P[1];if(S&&(!S.eventGroup||(S.eventGroup&&Alfresco.util.hasEventInterest(this,P)))){this.selectedItems={};this.singleSelectedItem="";for(var Q in this.itemSelectButtons){if(this.itemSelectButtons.hasOwnProperty(Q)){this.itemSelectButtons[Q].set("disabled",false)}}}},_setDefaultDataTableErrors:function K(P){var Q=Alfresco.util.message;P.set("MSG_EMPTY",Q("message.empty","Alfresco.GroupFinder"));P.set("MSG_ERROR",Q("message.error","Alfresco.GroupFinder"))},_performSearch:function B(P){if(!this.isSearching){this.isSearching=true;this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.set("MSG_EMPTY",this.msg("message.searching"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.widgets.dataTable.render();var Q=function S(U,V,W){this._enableSearchUI();this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,U,V,W)};var R=function T(V,W){this._enableSearchUI();if(W.status==401){window.location.reload()}else{try{var U=YAHOO.lang.JSON.parse(W.responseText);this.widgets.dataTable.set("MSG_ERROR",U.message);this.widgets.dataTable.showTableMessage(U.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(X){this._setDefaultDataTableErrors(this.widgets.dataTable)}}};this.searchTerm=P;this.widgets.dataSource.sendRequest(this._buildSearchParams(P),{success:Q,failure:R,scope:this});this.widgets.searchButton.set("disabled",true);YAHOO.lang.later(2000,this,function(){if(this.isSearching){if(!this.widgets.feedbackMessage){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.searching",this.name),spanClass:"wait",displayTime:0})}else{if(!this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.show()}}}},[])}},_enableSearchUI:function M(){if(this.widgets.feedbackMessage&&this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.hide()}this.widgets.searchButton.set("disabled",false);this.isSearching=false},_buildSearchParams:function F(P){return"shortNameFilter="+(this.options.wildcardPrefix?"*":"")+encodeURIComponent(P)}})})();